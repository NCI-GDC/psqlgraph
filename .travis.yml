os: linux
dist: bionic
language: python
python:
  - "3.6"
  - "3.7"
  - "3.8"
  - "3.9"
  - "3.10"
  - "3.11-dev"

addons:
  postgresql: "13"
  apt:
    packages:
      - postgresql-13
      - postgresql-client-13
      # Below are required for installing pipx
      - python3-pip
      - python3-venv

before_install:
  # Copy custom configs from the repo because PG-13 isn't set up to run like
  # it normally does on Travis out of the box.
  - sudo cp travis/postgresql.conf /etc/postgresql/13/main/postgresql.conf
  - sudo cp travis/pg_hba.conf /etc/postgresql/13/main/pg_hba.conf
  - sudo pg_ctlcluster 13 main restart

install:
  - /usr/bin/python3 -m pip install pipx --user
  - pipx install poetry
  - pipx inject poetry poetry-dynamic-versioning
  - pip install tox-travis tox-poetry

before_script:
  - psql -U postgres -c "create user test with superuser password 'test';"
  - psql -U postgres -c "create database automated_test with owner test;"

script:
  - tox

after_script:
  - test $TRAVIS_PYTHON_VERSION = "3.9" && tox -e coverage

jobs:
  allow_failures:
    - python: "3.11-dev"
