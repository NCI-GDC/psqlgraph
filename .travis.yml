os: linux
dist: jammy
language: python
python:
  - "3.7"
  - "3.8"
  - "3.9"
  - "3.10"
  - "3.11"
env:
  TOX_PYTHON=python
addons:
  postgresql: "13"
  apt:
    packages:
      - "python3-pip"
      - "python3-venv"
before_install:
  # Install postgres
  - sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
  - wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
  - sudo apt update
  - sudo apt install postgresql-13 postgresql-client-13
  # Configure postres
  - sudo cp travis/postgresql.conf /etc/postgresql/13/main/postgresql.conf
  - sudo cp travis/pg_hba.conf /etc/postgresql/13/main/pg_hba.conf
  - sudo service postgresql restart
  # Install pipx
  - /usr/bin/python -m pip install pipx --user
install:
  - pipx install --python=$TOX_PYTHON tox
  - pipx inject --pip-args='--upgrade' tox setuptools 
  - pipx install poetry
  - pipx inject poetry poetry-dynamic-versioning
before_script:
  - psql -U postgres -c "create user test with superuser password 'test';"
  - psql -U postgres -c "create database automated_test with owner test;"
script:
  - export TOXENV=$(python -V | sed -E 's/Python ([2-3]).([0-9]+?).[0-9]+/py\1\2/g')
  - tox

jobs:
  include:
    - dist: focal
      python: "3.6"
      env:
        TOX_PYTHON=/usr/bin/python3.8
      before_install:
        # Configure postgres
        - sudo cp travis/postgresql.conf /etc/postgresql/13/main/postgresql.conf
        - sudo cp travis/pg_hba.conf /etc/postgresql/13/main/pg_hba.conf
        - sudo pg_ctlcluster 13 main restart
        # Install pipx
        - /usr/bin/python3.8 -m pip install pipx --user
